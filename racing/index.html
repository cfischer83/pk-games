<html>
<head>
<title>Race!</title>
<script type="text/javascript">
window.module = {};
</script>
<script type="text/javascript" src="confetti.js"></script>
<script type="text/javascript">
window.confetti = module.exports;
</script>
<script defer src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.3.0/ace.js"></script>
<script defer src="https://cdnjs.cloudflare.com/ajax/libs/js-beautify/1.7.5/beautify.min.js"></script>
<script type="text/javascript" src="http://code.jquery.com/jquery-1.8.3.js"></script>


<style type="text/css">
body {
	margin:0;
	background: #336633;
}
body, p, li, label {
	color: #FFF;
	font-family: Helvetica Neue, Sans-serif;
}
.box {
	display: block;
	position: absolute;
	width: 50px;
	height: 50px;
	border-radius: 5px;
}
.red {
	background: red;
}
.blue {
	background: blue;
}
#road-container {
	height: 100%;
	width: 533px;
	overflow: hidden;
	margin: 0 auto;
	position: relative;
}
.start {
	margin-top: -16000px;
	transition: all 40000ms ease-in;
}
#road {
	width: 100%;
	height: 16000px;
	background: url(road.jpg) 0 0 repeat-y #333;
}
#commands {
	position: absolute;
	margin: 10px;
}
.btn {
	background: transparent;
	border: 3px solid #FFF;
	color: #FFF;
	border-radius: 5px;
	padding: 10px 20px;
	font-size: 20px;
	text-transform: uppercase;
	cursor: pointer;
}
.btn:hover {
	background: #252;
}
#start-btn {
	display: block;
}
#restart-btn {
	display: none;
}
#finish-line {
	width: 600px;
	height: 240px;
	background: url(finish-line.jpg) 0 0 no-repeat;
}
.rock {
	width:50px;
	height:50px;
	background: url(rock.png) 0 0 no-repeat transparent;
	background-size: contain;
	margin: 200px 0 0;
	position: absolute;
}
#car {
	margin-top: 50px;
	background: url(car2.png) 0 0 no-repeat;
	background-size: 50px 50px;
	transition: all 50ms linear;
}
#car.left {
	transform: rotate(25deg);
}
#car.right {
	transform: rotate(-25deg);
}

</style>
<script type="text/javascript">
var global_increment_by = 10;
var global_box_size = 50;
var global_window_size = 533;
var max_rock_x = global_window_size - global_box_size;
var global_it = 'red';
var gameInterval = null;

function pkAnalytics(action, label) {
	if (ga) {
		ga('send', {
			hitType: 'event',
			eventCategory: 'Game',
			eventAction: action,
			eventLabel: label
		});
	}
}

document.addEventListener("DOMContentLoaded", function(event) { 
	var car = document.getElementById("car");
	if ( window.location.hash == "#hard") {
		document.getElementById("hard").checked = true;
		setTimeout('document.getElementById("hard").blur();', 50);
		hardMode();
	} else if (window.location.hash == "#impossible") {
		document.getElementById("impossible").checked = true;
		setTimeout('document.getElementById("impossible").blur();', 50);
		impossibleMode();
	} else {
		setTimeout('document.getElementById("easy").blur();', 50);
		easyMode();
	}
});



// window.addEventListener("keydown", function(event) {
// 	var key = event.keyCode;
// 	var car = document.getElementById("car");

// 	// RED BOX
// 	if (key == 37) { // left
// 		//moveBlockLeft(car);
// 	}
// 	if (key == 39) { // right 
// 		//moveBlockRight(car);
// 	}
	

// 	//setTimeout('doBlocksOverLap(car, redBox)', 50);
// });

var downTimer;
var lastKey;
$(document).ready(function() {
	$(document.body).keydown(function(e) {
	    // if not still the same key, stop the timer
	    if (e.which !== lastKey) {
	        if (downTimer) {
	            clearInterval(downTimer);
	            downTimer = null;
	        }
	    }
	    // remember previous key
	    lastKey = e.which;
	    if (!downTimer) {
	        // start timer
	        downTimer = setInterval(function() {
	            if (e.which == 37) {
	            	car.classList.add("left");
					moveBlockLeft(car);
	            }
	            else if (e.which == 39) {
	            	car.classList.add("right");
	            	moveBlockRight(car);
	            } else {
	            	car.classList.remove("left");
	            	car.classList.remove("right");
	            }
	        }, 35);
	    }
	}).keyup(function(e) {
	    // stop timer
	    if (downTimer) {
	        clearInterval(downTimer);
	        downTimer = null;
	        lastKey = 0;
	        car.classList.remove("left");
        	car.classList.remove("right");
	    }
	});
});

function moveBlockLeft(block) {
	var marginLeft = block.style.marginLeft ? parseInt(block.style.marginLeft) : 0;
	var newMarginLeft = marginLeft - global_increment_by;
	if (newMarginLeft >= 0) {
		block.style.marginLeft = newMarginLeft + "px";
	}
}
function moveBlockRight(block) {
	var marginLeft = block.style.marginLeft ? parseInt(block.style.marginLeft) : 0;
	var newMarginLeft = marginLeft + global_increment_by;
	if (newMarginLeft <= (global_window_size-global_box_size)) {
		block.style.marginLeft = newMarginLeft + "px";
	}
}


function doBlocksOverLap(box1, box2) {
	var box1viewportOffset = box1.getBoundingClientRect();
	var box1XStart	= box1viewportOffset.x ? parseInt(box1viewportOffset.x) : 0;
	var box1XEnd 	= box1XStart + global_box_size;
	var box1YStart	= box1viewportOffset.y ? parseInt(box1viewportOffset.y) : 0;
	var box1YEnd	= box1YStart + global_box_size;

	var box2viewportOffset = box2.getBoundingClientRect();
	var box2XStart	= box2viewportOffset.x ? parseInt(box2viewportOffset.x) : 0;
	var box2XEnd 	= box2XStart + box2.getBoundingClientRect().width;
	var box2YStart	= box2viewportOffset.y ? parseInt(box2viewportOffset.y) : 0;
	var box2YEnd	= box2YStart + box2.getBoundingClientRect().height;

	var xOverLapStart = (box1XStart >= box2XStart && box1XStart <= box2XEnd);
	var xOverLapEnd = (box1XEnd >= box2XStart && box1XEnd <= box2XEnd);
	var yOverLapStart = (box1YStart >= box2YStart && box1YStart <= box2YEnd);
	var yOverLapEnd = (box1YEnd >= box2YStart && box1YEnd <= box2YEnd);
	if ((yOverLapStart || yOverLapEnd) && (xOverLapStart || xOverLapEnd)) {
		return true;
	} else {
		return false;
	}
}

function placeRocks(num) {
	rockNumber = num;
	var startingPos = 200;
	var endintPos = 15500;
	var road = document.getElementById("road");
	for (var i = 0; i < rockNumber; i++) {
		var rock = document.createElement("div");
			rock.classList.add("rock");
		road.appendChild(rock);
		var marginTop = randomNumber(startingPos, endintPos);
		// if (marginTop < startingPos) {
		// 	marginTop = marginTop + startingPos;
		// }
		var marginLeft = randomNumber(0, max_rock_x);
		rock.style.marginTop = marginTop + "px";
		rock.style.marginLeft = marginLeft + "px";
	}
}

function randomNumber(min, max) { 
    return Math.random() * (max - min) + min;
} 

function checkAllRocks() {
	var rocks = document.getElementsByClassName("rock");
	var carStyle = car.currentStyle || window.getComputedStyle(car);
	for (i = 0; i < rocks.length; i++) {
		rockStyle = rocks[i].currentStyle || window.getComputedStyle(rocks[i]);
		if (doBlocksOverLap(car, rocks[i])) {
			loseGame();
		}
	}
	var finishLine = document.getElementById("finish-line");
	if (doBlocksOverLap(car, finishLine)) {
		winGame();
	}
}

function startGame() {
	document.getElementById("road").classList.add("start");
	document.getElementById("start-btn").style.display = "none";
	document.getElementById("restart-btn").style.display = "block";
	gameInterval = setInterval('checkAllRocks()', 200);
	pkAnalytics("racing:start", getMode());
}

function getMode() {
	return document.controls.mode.value;
}

function winGame() {
	clearInterval(gameInterval);
	runConfetti();
	pkAnalytics("racing:win", getMode());
}

function loseGame() {
	clearInterval(gameInterval);
	var road = document.getElementById("road");
	var computedStyle = window.getComputedStyle(road);
	console.log(computedStyle);
	var marginTop = computedStyle.getPropertyValue('margin-top');
	console.log(marginTop);
	road.style.marginTop = marginTop;
	road.classList.remove("start");
	if (downTimer) {
        clearInterval(downTimer);
        downTimer = null;
        lastKey = 0;
    }
	alert("You hit a rock!");
	pkAnalytics("racing:lose", getMode());
}

function easyMode() {
	document.getElementById("road").innerHTML = "";
	placeRocks(50);
}

function hardMode() {
	document.getElementById("road").innerHTML = "";
	placeRocks(100);
}
function impossibleMode() {
	document.getElementById("road").innerHTML = "";
	placeRocks(150);
}
function runConfetti() {
	confetti({
		particleCount: 200,
		spread: 70,
		origin: { y: 0.6 }
	});
}

function restartGame() {
	var road = document.getElementById("road");
		road.style.marginTop = "0px";
	var url = window.location.href.split("#");
	var path = url[0].split("?");
	var rawpath = path[0] + "?r=" + Math.random();
	if (window.location.hash.length > 0) {
		rawpath = rawpath + window.location.hash;
	}
	window.location.href = rawpath;
}
</script>
</head>
<body>

<div id="commands">
	<form name="controls">
		<button onclick="startGame(); this.blur();" id="start-btn" class="btn">Start</button>
		<button onclick="restartGame();" id="restart-btn" class="btn">Restart</button>
		<p>Use the left & right key to avoid the rocks!</p>
		<label><input type="radio" id="easy" value="easy" name="mode" onclick="easyMode(); window.location.hash = 'easy'; this.blur();" checked="checked"> Easy Mode</label><br />
		<label><input type="radio" id="hard" value="hard" name="mode" onclick="hardMode(); window.location.hash = 'hard';this.blur();"> Hard Mode</label><br />
		<label><input type="radio" id="impossible" value="impossible" name="mode" onclick="impossibleMode(); window.location.hash = 'impossible';this.blur();"> Impossible Mode</label>
	</form>
</div>


<div id="road-container">
	<div class="box" id="car"></div>
	<div id="road">
	</div>
	<div id="finish-line"></div>
	
</div>

<script>(function() {
	(function (i, s, o, g, r, a, m) {
		i['GoogleAnalyticsObject'] = r;
		i[r] = i[r] || function () {
				(i[r].q = i[r].q || []).push(arguments)
			}, i[r].l = 1 * new Date();
		a = s.createElement(o),
			m = s.getElementsByTagName(o)[0];
		a.async = 1;
		a.src = g;
		m.parentNode.insertBefore(a, m)
	})(window, document, 'script', 'https://google-analytics.com/analytics.js', 'ga');
	
	ga('create', 'UA-3392560-1', 'auto');
			ga('send', 'pageview');
	})();
 </script> 
</body>
</html>